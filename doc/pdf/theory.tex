\documentclass[a4paper,american,floatfix,pdftex,superscriptaddress,twoside,%
aps,pra,
% citeautoscript,% leave away for latexdiff
linenumbers,% remove for arXiv
% longbibliography,% not needed for revtex 4.2
% preprint,%
% galley,%
reprint,%final% add final to see real layout, no todonotes anymore, ...
]{revtex4-2}%
\usepackage{amsfonts,amsmath,amssymb}
\usepackage[T1]{fontenc}
\usepackage{graphicx}%
\usepackage[utf8]{inputenc}
\usepackage{mathtools}
\usepackage{hyperref, hypernat}
\usepackage[displaymath,textmath,graphics]{preview}
\DeclarePairedDelimiter{\ceil}{\lceil}{\rceil}
\graphicspath{{./figures/}} % define figure directory

\newcommand{\cfeldesy}{\affiliation{Center for Free-Electron Laser Science, Deutsches
      Elektronen-Synchrotron DESY, Notkestra√üe 85, 22607 Hamburg, Germany}}%
\newcommand{\ezemail}{\email{emil.zak@cfel.de}}%


\begin{document}
\title{CHIRALEX: theory}

\author{Emil J.\ Zak}\ezemail\cfeldesy% 
\date{\today}%
\begin{abstract}\noindent%


\end{abstract}
\maketitle%

\section{Introduction}

Essential parameters are kept in the \textit{params} dictionary, which is passed throughout the program. It is used to construct all types of objects, from grids to the propagator object.

\section{basis functions and grids}

\subsection{Radial quadratures}

\subsection{Radial grid}
The radial grid used to solve the TDSE is based on an underlying Gauss-Lobatto (GL) quadrature scheme. 
First, a generic quadrature grid is created: $\lbrace x_k\rbrace_{k=0,1,...,Nlobs-1} \in [-1,1]$. Its size is determined by the \textit{Nlobs} input parameter ($Nl$ for short notation). Note that the boundary points in the Gauss-Lobatto grid are $-1$ and $+1$. 
The GL grid is then scaled to reflect the bin size $R_b$ requested by the user ($binw$ input parameter):

\begin{equation}
S_k = \frac{1}{2}R_b\left(x_k + 1\right)
\end{equation} 

Bin size must be determined empirically to ensure good convergence and stability of the results.
Next, the scaled grid is copied and translated by the bin size to generate the full primitive radial grid $G_{prim}$:

\begin{equation}
r_{ik} = S_k + T_i, \qquad i=0,1,...,Nb-1 \;,k=0,1,...,Nlobs-1 
\end{equation} 
where $T_i = i \cdot R_b + \epsilon$. The constant shift $\epsilon$ (rshift keyword) is optional and by default is set to 0.
The resulting grid has the size $Nb \times Nlobs $ and contains boundary points $r_{00} = \epsilon$ and $r_{Nb-1,Nlobs-1} = R_{max}$. The last point from bin $i$ and the first point from bin $i+1$ are identical in the primitive grid.

The \textit{coupled grid} $G$ is generated by removing boundary points, plus merging duplicate points at bin boundaries in $G_{prim}$. Through these operations the size of the coupled grid is $Nr =  Nb \times (Nlobs - 1) -1 $. Note that all indices start from $0$ for python compatibility. For example $G_{00} = r_{01}$ and $G_{0,Nl-3} = r_{0,Nl-2}$. The boundary of the first bin is at $G_{0,Nl-2} = r_{0,Nl-1} = r_{10}$. The last point in the coupled grid is $G_{Nb-1,Nl-3} = r_{Nb-1,Nl-2}$.


\subsection{Radial basis functions}

\subsubsection{Interpolated radial functions}

\subsection{Angular basis functions}


\section{index mapping}



\section{Rotated electrostatic potential}
Each molecular-frame orientation gives different electrostatic potential as seen from the laboratory frame, in which the basis set is defined. This means that for each orientation one must generate generally a different Lebedev quadrature grid. Even if a global scheme is used, the values of the electrostatic potential will be different at these points for each orientation. This is because the lebedev grid is defined in the laboratory frame. Therefore at this stage, a separate Psi4 calculation must be initialized for each orientation. I do not see a way around it at the moment, other than performing multipole expansion and calculating the angular part (spherical tensor form) of the potential analytically. But finding this expansion is costly, even more than running Psi4 for every orientation.

\section{Kinetic energy operator}

\section{Hamiltonian}
We decided to keep the bound state Hamiltonian $H_0$ and the initial propagation Hamiltonian $H_{init}$ as separate entities, calculated independently. The computational overhead related to calculating the bound-state part twice is marginal, as we assume that the full propagation basis is much bigger than the basis for the bound Hamiltonian $Nbas \gg Nbas0$. Future releases might recycle the bound state KEO and POT and build only the outside region Hamiltonian.

\section{Wavepacket propagation}
\subsection{time grid}
The time grid for the calculation is determined by the input keywords:
\begin{table}[h!]
	\begin{center}
		\caption{Time grid keywords.}
		\label{tab:time-grids}
		\begin{tabular}{l|c|r}
			\textbf{keyword} & \textbf{description} & \textbf{type}\\
			\hline
			t0 & start time & float\\
			tmax & end time & float\\
			dt & time step & float\\
			time\_units & units & string \\
			wfn\_saverate & save rate of the wavepacket  & float \\
			
		\end{tabular}
	\end{center}
\end{table}

The generated grid is equidistant given by the following formula:
\begin{equation}
t[i] = t_0 + i \cdot dt ;\ i=0,1,2,...,Ntpts
\end{equation}
where 
\begin{equation}
Ntpts = \ceil[\Bigg]{\frac{t_{max}-t_0}{dt}}
\end{equation}
such that the array of time-points contains elements: $t[0],t[1],...,t[Ntpts]$.
Note that the last point (tmax) is included in the grid. 


\bibliography{theory}
\end{document}

